/*
 * This file is part of the 
 *
 * Copyright (c) 2017-2018 linghaibin
 *
 */
 
#include "analog_quantity.h"
#include "delay.h"
#include "flash.h"
#include "can.h"

struct kanlman_val {
     double PreOptimalVar;                       //先前最优值
     double CurMeasVar;
     double CurEstimateVar;        //当前测量值，当前预测值
     double CurOptimalVar;                      //当前最优值
     double CurSysCoVar;
     double PreSysCoVar;         //当前系统协方差，先前系统协方差
     double KalmanGain;                         //卡尔曼增益
     uint32_t AdjustVar;
};

struct kanlman_val k_val[8];

static uint16_t adc_value[9];
static uint16_t average_value[8];
static ads_read_mode al_am[8] = {AM_NULL,AM_NULL,AM_NULL,AM_NULL,AM_NULL,AM_NULL,AM_NULL,AM_NULL};
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/
const float pt100_table[1491] = {
    80.7033,80.66036,80.6239,80.5842,80.5445,80.5048,80.4651,80.4254,80.3857,80.346,
    81.1003,81.0606,81.0209,80.9812,80.9415,80.9018,80.8621,80.8224,80.7827,80.743,
    81.497,81.4573,81.4177,81.378,81.3383,81.2987,81.259,81.2193,81.1796,81.14,
    81.8937,81.854,81.8144,81.7747,81.735,81.6954,81.6557,81.616,81.5763,81.5367,
    82.2902,82.2506,82.2109,82.1713,82.1316,82.092,82.0523,82.0127,81.973,81.9334,
    82.6865,82.6469,82.6072,82.5676,82.528,82.4884,82.4487,82.4091,82.3695,82.3298,
    83.0828,83.0432,83.0035,82.9639,82.9243,82.8847,82.845,82.8054,82.7658,82.7261,
    83.4789,83.4393,83.3997,83.3601,83.3205,83.2809,83.2412,83.2016,83.162,83.1224,
    83.8748,83.8352,83.7956,83.756,83.7164,83.6769,83.6373,83.5977,83.5581,83.5185,
    84.2707,84.2311,84.1915,84.1519,84.1123,84.0728,84.0332,83.9936,83.954,83.9144,
    84.6664,84.6268,84.5873,84.5477,84.5081,84.4686,84.429,84.3894,84.3498,84.3103,
    85.0619,85.0224,84.9828,84.9433,84.9037,84.8642,84.8246,84.7851,84.7455,84.706,
    85.4573,85.4179,85.3783,85.3388,85.2992,85.2597,85.2201,85.1806,85.141,85.1015,
    85.8526,85.8131,85.7735,85.734,85.6945,85.655,85.6154,85.5759,85.5364,85.4968,
    86.2478,86.2082,86.1688,86.1292,86.0897,86.0502,86.0107,85.9712,85.9316,85.8921,
    86.6428,86.6033,86.5638,86.5243,86.4848,86.4453,86.4058,86.3663,86.3268,86.2873,
    87.0377,86.9982,86.9587,86.9192,86.8797,86.8403,86.8008,86.7613,86.7218,86.6823,
    87.4325,87.393,87.3535,87.3141,87.2746,87.2351,87.1956,87.1561,87.1166,87.0772,
    87.8272,87.7877,87.7483,87.7088,87.6693,87.6299,87.5904,87.5509,87.5114,87.472,
    88.2217,88.1823,88.1428,88.1034,88.0639,88.0245,87.985,87.9456,87.9061,87.8667,
    88.6161,88.5766,88.5372,88.4978,88.4583,88.4189,88.3795,88.34,88.3006,88.2611,
    89.0103,88.9709,88.9315,88.892,88.8526,88.8132,88.7738,88.7344,88.6949,88.6555,
    89.4044,89.365,89.3256,89.2862,89.2468,89.2074,89.1679,89.1285,89.0891,89.0497,
    89.7985,89.7591,89.7197,89.6803,89.6409,89.6015,89.562,89.5226,89.4832,89.4438,
    90.1923,90.1529,90.1135,90.0742,90.0348,89.9954,89.956,89.9166,89.8773,89.8379,
    90.5861,90.5467,90.5073,90.468,90.4286,90.3892,90.3498,90.3104,90.2711,90.2317,
    90.9798,90.9404,90.9011,90.8617,90.8223,90.783,90.7436,90.7042,90.6648,90.6255,
    91.3733,91.334,91.2946,91.2553,91.2159,91.1766,91.1372,91.0979,91.0585,91.0192,
    91.7666,91.7273,91.6879,91.6486,91.6093,91.57,91.5306,91.4913,91.452,91.4126,
    92.1599,92.1206,92.0812,92.0419,92.0026,91.9633,91.9239,91.8846,91.8453,91.8059,
    92.5531,92.5138,92.4745,92.4351,92.3958,92.3565,92.3172,92.2779,92.2385,92.1992,
    92.946,92.9067,92.8674,92.8281,92.7888,92.7496,92.7103,92.671,92.6317,92.5924,
    93.339,93.2997,93.2604,93.2211,93.1818,93.1425,93.1032,93.0639,93.0246,92.9853,
    93.7317,93.6924,93.6532,93.6139,93.5746,93.5354,93.4961,93.4568,93.4175,93.3783,
    94.1244,94.0851,94.0459,94.0066,93.9673,93.9281,93.8888,93.8495,93.8102,93.771,
    94.517,94.4777,94.4385,94.3992,94.36,94.3207,94.2814,94.2422,94.2029,94.1637,
    94.9094,94.8702,94.8309,94.7917,94.7524,94.7132,94.674,94.6347,94.5955,94.5562,
    95.3016,95.2624,95.2232,95.1839,95.1447,95.1055,95.0663,95.0271,94.9878,94.9486,
    95.6938,95.6546,95.6154,95.5761,95.5369,95.4977,95.4585,95.4193,95.38,95.3408,
    96.0859,96.0467,96.0075,95.9683,95.9291,95.8899,95.8506,95.8114,95.7722,95.733,
    96.4779,96.4387,96.3995,96.3603,96.3211,96.2819,96.2427,96.2035,96.1643,96.1251,
    96.8697,96.8305,96.7913,96.7522,96.713,96.6738,96.6346,96.5954,96.5563,96.5171,
    97.2614,97.2222,97.1831,97.1439,97.1047,97.0656,97.0264,96.9872,96.948,96.9089,
    97.6529,97.6138,97.5746,97.5355,97.4963,97.4572,97.418,97.3789,97.3397,97.3006,
    98.0444,98.0053,97.9662,97.927,97.8879,97.8487,97.8096,97.7704,97.7313,97.6921,
    98.4358,98.3967,98.3575,98.3184,98.2793,98.2401,98.201,98.1618,98.1227,98.0835,
    98.827,98.7879,98.7488,98.7096,98.6705,98.6314,98.5923,98.5532,98.514,98.4749,
    99.2181,99.17899,99.1399,99.1008,99.0617,99.0226,98.9834,98.9443,98.9052,98.8661,
    99.6091,99.57,99.5309,99.4918,99.4527,99.4136,99.3745,99.3354,99.2963,99.2572,
 
    100.0000, 100.0391, 100.0782, 100.1172, 100.1563, 100.1954, 100.2345, 100.2736, 100.3126, 100.3517,
    100.3908, 100.4298, 100.4689, 100.5080, 100.5470, 100.5861, 100.6252, 100.6642, 100.7033, 100.7424,
    100.7814, 100.8205, 100.8595, 100.8986, 100.9377, 100.9767, 101.0158, 101.0548, 101.0939, 101.1329,
    101.1720, 101.2110, 101.2501, 101.2891, 101.3282, 101.3672, 101.4062, 101.4453, 101.4843, 101.5234,
    101.5624, 101.6014, 101.6405, 101.6795, 101.7185, 101.7576, 101.7966, 101.8356, 101.8747, 101.9137,
    101.9527, 101.9917, 102.0308, 102.0698, 102.1088, 102.1478, 102.1868, 102.2259, 102.2649, 102.3039,
    102.3429, 102.3819, 102.4209, 102.4599, 102.4989, 102.5380, 102.5770, 102.6160, 102.6550, 102.6940,
    102.7330, 102.7720, 102.8110, 102.8500, 102.8890, 102.9280, 102.9670, 103.0060, 103.0450, 103.0840,
    103.1229, 103.1619, 103.2009, 103.2399, 103.2789, 103.3179, 103.3569, 103.3958, 103.4348, 103.4738,
    103.5128, 103.5518, 103.5907, 103.6297, 103.6687, 103.7077, 103.7466, 103.7856, 103.8246, 103.8636,
    103.9025, 103.9415, 103.9805, 104.0194, 104.0584, 104.0973, 104.1363, 104.1753, 104.2142, 104.2532,
    104.2921, 104.3311, 104.3701, 104.4090, 104.4480, 104.4869, 104.5259, 104.5648, 104.6038, 104.6427,
    104.6816, 104.7206, 104.7595, 104.7985, 104.8374, 104.8764, 104.9153, 104.9542, 104.9932, 105.0321,
    105.0710, 105.1100, 105.1489, 105.1878, 105.2268, 105.2657, 105.3046, 105.3435, 105.3825, 105.4214,
    105.4603, 105.4992, 105.5381, 105.5771, 105.6160, 105.6549, 105.6938, 105.7327, 105.7716, 105.8105,
    105.8495, 105.8884, 105.9273, 105.9662, 106.0051, 106.0440, 106.0829, 106.1218, 106.1607, 106.1996,
    106.2385, 106.2774, 106.3163, 106.3552, 106.3941, 106.4330, 106.4719, 106.5108, 106.5496, 106.5885,
    106.6274, 106.6663, 106.7052, 106.7441, 106.7830, 106.8218, 106.8607, 106.8996, 106.9385, 106.9774,
    107.0162, 107.0551, 107.0940, 107.1328, 107.1717, 107.2106, 107.2495, 107.2883, 107.3272, 107.3661,
    107.4049, 107.4438, 107.4826, 107.5215, 107.5604, 107.5992, 107.6381, 107.6769, 107.7158, 107.7546,
    107.7935, 107.8324, 107.8712, 107.9101, 107.9489, 107.9877, 108.0266, 108.0654, 108.1043, 108.1431,
    108.1820, 108.2208, 108.2596, 108.2985, 108.3373, 108.3762, 108.4150, 108.4538, 108.4926, 108.5315,
    108.5703, 108.6091, 108.6480, 108.6868, 108.7256, 108.7644, 108.8033, 108.8421, 108.8809, 108.9197,
    108.9585, 108.9974, 109.0362, 109.0750, 109.1138, 109.1526, 109.1914, 109.2302, 109.2690, 109.3078,
    109.3467, 109.3855, 109.4243, 109.4631, 109.5019, 109.5407, 109.5795, 109.6183, 109.6571, 109.6959,
    109.7347, 109.7734, 109.8122, 109.8510, 109.8898, 109.9286, 109.9674, 110.0062, 110.0450, 110.0838,
    110.1225, 110.1613, 110.2001, 110.2389, 110.2777, 110.3164, 110.3552, 110.3940, 110.4328, 110.4715,
    110.5103, 110.5491, 110.5879, 110.6266, 110.6654, 110.7042, 110.7429, 110.7817, 110.8204, 110.8592,
    110.8980, 110.9367, 110.9755, 111.0142, 111.0530, 111.0917, 111.1305, 111.1693, 111.2080, 111.2468,
    111.2855, 111.3242, 111.3630, 111.4017, 111.4405, 111.4792, 111.5180, 111.5567, 111.5954, 111.6342,
    111.6729, 111.7117, 111.7504, 111.7891, 111.8279, 111.8666, 111.9053, 111.9441, 111.9828, 112.0215,
    112.0602, 112.0990, 112.1377, 112.1764, 112.2151, 112.2538, 112.2926, 112.3313, 112.3700, 112.4087,
    112.4474, 112.4861, 112.5248, 112.5636, 112.6023, 112.6410, 112.6797, 112.7184, 112.7571, 112.7958,
    112.8345, 112.8732, 112.9119, 112.9506, 112.9893, 113.0280, 113.0667, 113.1054, 113.1441, 113.1828,
    113.2215, 113.2602, 113.2988, 113.3375, 113.3762, 113.4149, 113.4536, 113.4923, 113.5309, 113.5696,
    113.6083, 113.6470, 113.6857, 113.7243, 113.7630, 113.8017, 113.8404, 113.8790, 113.9177, 113.9564,
    113.9950, 114.0337, 114.0724, 114.1110, 114.1497, 114.1884, 114.2270, 114.2657, 114.3043, 114.3430,
    114.3817, 114.4203, 114.4590, 114.4976, 114.5363, 114.5749, 114.6136, 114.6522, 114.6909, 114.7295,
    114.7681, 114.8068, 114.8454, 114.8841, 114.9227, 114.9614, 115.0000, 115.0386, 115.0773, 115.1159,
    115.1545, 115.1932, 115.2318, 115.2704, 115.3091, 115.3477, 115.3863, 115.4249, 115.4636, 115.5022,
    115.5408, 115.5794, 115.6180, 115.6567, 115.6953, 115.7339, 115.7725, 115.8111, 115.8497, 115.8883,
    115.9270, 115.9656, 116.0042, 116.0428, 116.0814, 116.1200, 116.1586, 116.1972, 116.2358, 116.2744,
    116.3130, 116.3516, 116.3902, 116.4288, 116.4674, 116.5060, 116.5446, 116.5831, 116.6217, 116.6603,
    116.6989, 116.7375, 116.7761, 116.8147, 116.8532, 116.8918, 116.9304, 116.9690, 117.0076, 117.0461,
    117.0847, 117.1233, 117.1619, 117.2004, 117.2390, 117.2776, 117.3161, 117.3547, 117.3933, 117.4318,
    117.4704, 117.5090, 117.5475, 117.5861, 117.6247, 117.6632, 117.7018, 117.7403, 117.7789, 117.8174,
    117.8560, 117.8945, 117.9331, 117.9716, 118.0102, 118.0487, 118.0873, 118.1258, 118.1644, 118.2029,
    118.2414, 118.2800, 118.3185, 118.3571, 118.3956, 118.4341, 118.4727, 118.5112, 118.5497, 118.5883,
    118.6268, 118.6653, 118.7038, 118.7424, 118.7809, 118.8194, 118.8579, 118.8965, 118.9350, 118.9735,
    119.0120, 119.0505, 119.0890, 119.1276, 119.1661, 119.2046, 119.2431, 119.2816, 119.3201, 119.3586,
    119.3971, 119.4356, 119.4741, 119.5126, 119.5511, 119.5896, 119.6281, 119.6666, 119.7051, 119.7436,
    119.7821, 119.8206, 119.8591, 119.8976, 119.9361, 119.9746, 120.0131, 120.0516, 120.0900, 120.1285,
    120.1670, 120.2055, 120.2440, 120.2824, 120.3209, 120.3594, 120.3979, 120.4364, 120.4748, 120.5133,
    120.5518, 120.5902, 120.6287, 120.6672, 120.7056, 120.7441, 120.7826, 120.8210, 120.8595, 120.8980,
    120.9364, 120.9749, 121.0133, 121.0518, 121.0902, 121.1287, 121.1672, 121.2056, 121.2441, 121.2825,
    121.3210, 121.3594, 121.3978, 121.4363, 121.4747, 121.5132, 121.5516, 121.5901, 121.6285, 121.6669,
    121.7054, 121.7438, 121.7822, 121.8207, 121.8591, 121.8975, 121.9360, 121.9744, 122.0128, 122.0513,
    122.0897, 122.1281, 122.1665, 122.2049, 122.2434, 122.2818, 122.3202, 122.3586, 122.3970, 122.4355,
    122.4739, 122.5123, 122.5507, 122.5891, 122.6275, 122.6659, 122.7043, 122.7427, 122.7811, 122.8195,
    122.8579, 122.8963, 122.9347, 122.9731, 123.0115, 123.0499, 123.0883, 123.1267, 123.1651, 123.2035,
    123.2419, 123.2803, 123.3187, 123.3571, 123.3955, 123.4338, 123.4722, 123.5106, 123.5490, 123.5874,
    123.6257, 123.6641, 123.7025, 123.7409, 123.7792, 123.8176, 123.8560, 123.8944, 123.9327, 123.9711,
    124.0095, 124.0478, 124.0862, 124.1246, 124.1629, 124.2013, 124.2396, 124.2780, 124.3164, 124.3547,
    124.3931, 124.4314, 124.4698, 124.5081, 124.5465, 124.5848, 124.6232, 124.6615, 124.6999, 124.7382,
    124.7766, 124.8149, 124.8533, 124.8916, 124.9299, 124.9683, 125.0066, 125.0450, 125.0833, 125.1216,
    125.1600, 125.1983, 125.2366, 125.2749, 125.3133, 125.3516, 125.3899, 125.4283, 125.4666, 125.5049,
    125.5432, 125.5815, 125.6199, 125.6582, 125.6965, 125.7348, 125.7731, 125.8114, 125.8497, 125.8881,
    125.9264, 125.9647, 126.0030, 126.0413, 126.0796, 126.1179, 126.1562, 126.1945, 126.2328, 126.2711,
    126.3094, 126.3477, 126.3860, 126.4243, 126.4626, 126.5009, 126.5392, 126.5775, 126.6157, 126.6540,
    126.6923, 126.7306, 126.7689, 126.8072, 126.8455, 126.8837, 126.9220, 126.9603, 126.9986, 127.0368,
    127.0751, 127.1134, 127.1517, 127.1899, 127.2282, 127.2665, 127.3048, 127.3430, 127.3813, 127.4195,
    127.4578, 127.4961, 127.5343, 127.5726, 127.6109, 127.6491, 127.6874, 127.7256, 127.7639, 127.8021,
    127.8404, 127.8786, 127.9169, 127.9551, 127.9934, 128.0316, 128.0699, 128.1081, 128.1464, 128.1846,
    128.2228, 128.2611, 128.2993, 128.3376, 128.3758, 128.4140, 128.4523, 128.4905, 128.5287, 128.5670,
    128.6052, 128.6434, 128.6816, 128.7199, 128.7581, 128.7963, 128.8345, 128.8728, 128.9110, 128.9492,
    128.9874, 129.0256, 129.0638, 129.1021, 129.1403, 129.1785, 129.2167, 129.2549, 129.2931, 129.3313,
    129.3695, 129.4077, 129.4459, 129.4841, 129.5223, 129.5605, 129.5987, 129.6369, 129.6751, 129.7133,
    129.7515, 129.7897, 129.8279, 129.8661, 129.9043, 129.9425, 129.9807, 130.0188, 130.0570, 130.0952,
    130.1334, 130.1716, 130.2098, 130.2479, 130.2861, 130.3243, 130.3625, 130.4006, 130.4388, 130.4770,
    130.5152, 130.5533, 130.5915, 130.6297, 130.6678, 130.7060, 130.7442, 130.7823, 130.8205, 130.8586,
    130.8968, 130.9350, 130.9731, 131.0113, 131.0494, 131.0876, 131.1257, 131.1639, 131.2020, 131.2402,
    131.2783, 131.3165, 131.3546, 131.3928, 131.4309, 131.4691, 131.5072, 131.5453, 131.5835, 131.6216,
    131.6597, 131.6979, 131.7360, 131.7742, 131.8123, 131.8504, 131.8885, 131.9267, 131.9648, 132.0029,
    132.0411, 132.0792, 132.1173, 132.1554, 132.1935, 132.2317, 132.2698, 132.3079, 132.3460, 132.3841,
    132.4222, 132.4603, 132.4985, 132.5366, 132.5747, 132.6128, 132.6509, 132.6890, 132.7271, 132.7652,
    132.8033, 132.8414, 132.8795, 132.9176, 132.9557, 132.9938, 133.0319, 133.0700, 133.1081, 133.1462,
    133.1843, 133.2224, 133.2604, 133.2985, 133.3366, 133.3747, 133.4128, 133.4509, 133.4889, 133.5270,
    133.5651, 133.6032, 133.6413, 133.6793, 133.7174, 133.7555, 133.7935, 133.8316, 133.8697, 133.9078,
    133.9458, 133.9839, 134.0220, 134.0600, 134.0981, 134.1361, 134.1742, 134.2123, 134.2503, 134.2884,
    134.3264, 134.3645, 134.4025, 134.4406, 134.4786, 134.5167, 134.5547, 134.5928, 134.6308, 134.6689,
    134.7069, 134.7450, 134.7830, 134.8211, 134.8591, 134.8971, 134.9352, 134.9732, 135.0112, 135.0493,
    135.0873, 135.1253, 135.1634, 135.2014, 135.2394, 135.2774, 135.3155, 135.3535, 135.3915, 135.4295,
    135.4676, 135.5056, 135.5436, 135.5816, 135.6196, 135.6577, 135.6957, 135.7337, 135.7717, 135.8097,
    135.8477, 135.8857, 135.9237, 135.9617, 135.9997, 136.0377, 136.0757, 136.1137, 136.1517, 136.1897,
    136.2277, 136.2657, 136.3037, 136.3417, 136.3797, 136.4177, 136.4557, 136.4937, 136.5317, 136.5697,
    136.6077, 136.6456, 136.6836, 136.7216, 136.7596, 136.7976, 136.8355, 136.8735, 136.9115, 136.9495,
    136.9875, 137.0254, 137.0634, 137.1014, 137.1393, 137.1773, 137.2153, 137.2532, 137.2912, 137.3292,
    137.3671, 137.4051, 137.4431, 137.4810, 137.5190, 137.5569, 137.5949, 137.6329, 137.6708, 137.7088,
    137.7467, 137.7847, 137.8226, 137.8606, 137.8985, 137.9365, 137.9744, 138.0123, 138.0503, 138.0882,
    138.1262, 138.1641, 138.2020, 138.2400, 138.2779, 138.3158, 138.3538, 138.3917, 138.4296, 138.4676,
    138.5055
};

const float pt1000_table[1491] = {
807.033 ,806.604 ,806.239 ,805.842 ,805.445 ,805.048 ,804.651 ,804.254 ,803.857 ,803.460 ,
811.003 ,810.606 ,810.209 ,809.812 ,809.415 ,809.018 ,808.621 ,808.224 ,807.827 ,807.430 ,
814.970 ,814.573 ,814.177 ,813.780 ,813.383 ,812.987 ,812.590 ,812.193 ,811.796 ,811.400 ,
818.937 ,818.540 ,818.144 ,817.747 ,817.350 ,816.954 ,816.557 ,816.160 ,815.763 ,815.367 ,
822.902 ,822.506 ,822.109 ,821.713 ,821.316 ,820.920 ,820.523 ,820.127 ,819.730 ,819.334 ,
826.865 ,826.469 ,826.072 ,825.676 ,825.280 ,824.884 ,824.487 ,824.091 ,823.695 ,823.298 ,
830.828 ,830.432 ,830.035 ,829.639 ,829.243 ,828.847 ,828.450 ,828.054 ,827.658 ,827.261 ,
834.789 ,834.393 ,833.997 ,833.601 ,833.205 ,832.809 ,832.412 ,832.016 ,831.620 ,831.224 ,
838.748 ,838.352 ,837.956 ,837.560 ,837.164 ,836.769 ,836.373 ,835.977 ,835.581 ,835.185 ,
842.707 ,842.311 ,841.915 ,841.519 ,841.123 ,840.728 ,840.332 ,839.936 ,839.540 ,839.144 ,
846.664 ,846.268 ,845.873 ,845.477 ,845.081 ,844.686 ,844.290 ,843.894 ,843.498 ,843.103 ,
850.619 ,850.224 ,849.828 ,849.433 ,849.037 ,848.642 ,848.246 ,847.851 ,847.455 ,847.060 ,
854.573 ,854.179 ,853.783 ,853.388 ,852.992 ,852.597 ,852.201 ,851.806 ,851.410 ,851.015 ,
858.526 ,858.131 ,857.735 ,857.340 ,856.945 ,856.550 ,856.154 ,855.759 ,855.364 ,854.968 ,
862.478 ,862.082 ,861.688 ,861.292 ,860.897 ,860.502 ,860.107 ,859.712 ,859.316 ,858.921 ,
866.428 ,866.033 ,865.638 ,865.243 ,864.848 ,864.453 ,864.058 ,863.663 ,863.268 ,862.873 ,
870.377 ,869.982 ,869.587 ,869.192 ,868.797 ,868.403 ,868.008 ,867.613 ,867.218 ,866.823 ,
874.325 ,873.930 ,873.535 ,873.141 ,872.746 ,872.351 ,871.956 ,871.561 ,871.166 ,870.772 ,
878.272 ,877.877 ,877.483 ,877.088 ,876.693 ,876.299 ,875.904 ,875.509 ,875.114 ,874.720 ,
882.217 ,881.823 ,881.428 ,881.034 ,880.639 ,880.245 ,879.850 ,879.456 ,879.061 ,878.667 ,
886.161 ,885.766 ,885.372 ,884.978 ,884.583 ,884.189 ,883.795 ,883.400 ,883.006 ,882.611 ,
890.103 ,889.709 ,889.315 ,888.920 ,888.526 ,888.132 ,887.738 ,887.344 ,886.949 ,886.555 ,
894.044 ,893.650 ,893.256 ,892.862 ,892.468 ,892.074 ,891.679 ,891.285 ,890.891 ,890.497 ,
897.985 ,897.591 ,897.197 ,896.803 ,896.409 ,896.015 ,895.620 ,895.226 ,894.832 ,894.438 ,
901.923 ,901.529 ,901.135 ,900.742 ,900.348 ,899.954 ,899.560 ,899.166 ,898.773 ,898.379 ,
905.861 ,905.467 ,905.073 ,904.680 ,904.286 ,903.892 ,903.498 ,903.104 ,902.711 ,902.317 ,
909.798 ,909.404 ,909.011 ,908.617 ,908.223 ,907.830 ,907.436 ,907.042 ,906.648 ,906.255 ,
913.733 ,913.340 ,912.946 ,912.553 ,912.159 ,911.766 ,911.372 ,910.979 ,910.585 ,910.192 ,
917.666 ,917.273 ,916.879 ,916.486 ,916.093 ,915.700 ,915.306 ,914.913 ,914.520 ,914.126 ,
921.599 ,921.206 ,920.812 ,920.419 ,920.026 ,919.633 ,919.239 ,918.846 ,918.453 ,918.059 ,
925.531 ,925.138 ,924.745 ,924.351 ,923.958 ,923.565 ,923.172 ,922.779 ,922.385 ,921.992 ,
929.460 ,929.067 ,928.674 ,928.281 ,927.888 ,927.496 ,927.103 ,926.710 ,926.317 ,925.924 ,
933.390 ,932.997 ,932.604 ,932.211 ,931.818 ,931.425 ,931.032 ,930.639 ,930.246 ,929.853 ,
937.317 ,936.924 ,936.532 ,936.139 ,935.746 ,935.354 ,934.961 ,934.568 ,934.175 ,933.783 ,
941.244 ,940.851 ,940.459 ,940.066 ,939.673 ,939.281 ,938.888 ,938.495 ,938.102 ,937.710 ,
945.170 ,944.777 ,944.385 ,943.992 ,943.600 ,943.207 ,942.814 ,942.422 ,942.029 ,941.637 ,
949.094 ,948.702 ,948.309 ,947.917 ,947.524 ,947.132 ,946.740 ,946.347 ,945.955 ,945.562 ,
953.016 ,952.624 ,952.232 ,951.839 ,951.447 ,951.055 ,950.663 ,950.271 ,949.878 ,949.486 ,
956.938 ,956.546 ,956.154 ,955.761 ,955.369 ,954.977 ,954.585 ,954.193 ,953.800 ,953.408 ,
960.859 ,960.467 ,960.075 ,959.683 ,959.291 ,958.899 ,958.506 ,958.114 ,957.722 ,957.330 ,
964.779 ,964.387 ,963.995 ,963.603 ,963.211 ,962.819 ,962.427 ,962.035 ,961.643 ,961.251 ,
968.697 ,968.305 ,967.913 ,967.522 ,967.130 ,966.738 ,966.346 ,965.954 ,965.563 ,965.171 ,
972.614 ,972.222 ,971.831 ,971.439 ,971.047 ,970.656 ,970.264 ,969.872 ,969.480 ,969.089 ,
976.529 ,976.138 ,975.746 ,975.355 ,974.963 ,974.572 ,974.180 ,973.789 ,973.397 ,973.006 ,
980.444 ,980.053 ,979.662 ,979.270 ,978.879 ,978.487 ,978.096 ,977.704 ,977.313 ,976.921 ,
984.358 ,983.967 ,983.575 ,983.184 ,982.793 ,982.401 ,982.010 ,981.618 ,981.227 ,980.835 ,
988.270 ,987.879 ,987.488 ,987.096 ,986.705 ,986.314 ,985.923 ,985.532 ,985.140 ,984.749 ,
992.181 ,991.790 ,991.399 ,991.008 ,990.617 ,990.226 ,989.834 ,989.443 ,989.052 ,988.661 ,
996.091 ,995.700 ,995.309 ,994.918 ,994.527 ,994.136 ,993.745 ,993.354 ,992.963 ,992.572 ,
1000.000 ,1000.391 ,1000.782 ,1001.172 ,1001.563 ,1001.954 ,1002.345 ,1002.736 ,1003.126 ,1003.517 ,
1003.908 ,1004.298 ,1004.689 ,1005.080 ,1005.470 ,1005.861 ,1006.252 ,1006.642 ,1007.033 ,1007.424 ,
1007.814 ,1008.205 ,1008.595 ,1008.986 ,1009.377 ,1009.767 ,1010.158 ,1010.548 ,1010.939 ,1011.329 ,
1011.720 ,1012.110 ,1012.501 ,1012.891 ,1013.282 ,1013.672 ,1014.062 ,1014.453 ,1014.843 ,1015.234 ,
1015.624 ,1016.014 ,1016.405 ,1016.795 ,1017.185 ,1017.576 ,1017.966 ,1018.356 ,1018.747 ,1019.137 ,
1019.527 ,1019.917 ,1020.308 ,1020.698 ,1021.088 ,1021.478 ,1021.868 ,1022.259 ,1022.649 ,1023.039 ,
1023.429 ,1023.819 ,1024.209 ,1024.599 ,1024.989 ,1025.380 ,1025.770 ,1026.160 ,1026.550 ,1026.940 ,
1027.330 ,1027.720 ,1028.110 ,1028.500 ,1028.890 ,1029.280 ,1029.670 ,1030.060 ,1030.450 ,1030.840 ,
1031.229 ,1031.619 ,1032.009 ,1032.399 ,1032.789 ,1033.179 ,1033.569 ,1033.958 ,1034.348 ,1034.738 ,
1035.128 ,1035.518 ,1035.907 ,1036.297 ,1036.687 ,1037.077 ,1037.466 ,1037.856 ,1038.246 ,1038.636 ,
1039.025 ,1039.415 ,1039.805 ,1040.194 ,1040.584 ,1040.973 ,1041.363 ,1041.753 ,1042.142 ,1042.532 ,
1042.921 ,1043.311 ,1043.701 ,1044.090 ,1044.480 ,1044.869 ,1045.259 ,1045.648 ,1046.038 ,1046.427 ,
1046.816 ,1047.206 ,1047.595 ,1047.985 ,1048.374 ,1048.764 ,1049.153 ,1049.542 ,1049.932 ,1050.321 ,
1050.710 ,1051.099 ,1051.489 ,1051.878 ,1052.268 ,1052.657 ,1053.046 ,1053.435 ,1053.825 ,1054.214 ,
1054.603 ,1054.992 ,1055.381 ,1055.771 ,1056.160 ,1056.549 ,1056.938 ,1057.327 ,1057.716 ,1058.105 ,
1058.495 ,1058.884 ,1059.273 ,1059.662 ,1060.051 ,1060.440 ,1060.829 ,1061.218 ,1061.607 ,1061.996 ,
1062.385 ,1062.774 ,1063.163 ,1063.552 ,1063.941 ,1064.330 ,1064.719 ,1065.108 ,1065.496 ,1065.885 ,
1066.274 ,1066.663 ,1067.052 ,1067.441 ,1067.830 ,1068.218 ,1068.607 ,1068.996 ,1069.385 ,1069.774 ,
1070.162 ,1070.551 ,1070.940 ,1071.328 ,1071.717 ,1072.106 ,1072.495 ,1072.883 ,1073.272 ,1073.661 ,
1074.049 ,1074.438 ,1074.826 ,1075.215 ,1075.604 ,1075.992 ,1076.381 ,1076.769 ,1077.158 ,1077.546 ,
1077.935 ,1078.324 ,1078.712 ,1079.101 ,1079.489 ,1079.877 ,1080.266 ,1080.654 ,1081.043 ,1081.431 ,
1081.820 ,1082.208 ,1082.596 ,1082.985 ,1083.373 ,1083.762 ,1084.150 ,1084.538 ,1084.926 ,1085.315 ,
1085.703 ,1086.091 ,1086.480 ,1086.868 ,1087.256 ,1087.644 ,1088.033 ,1088.421 ,1088.809 ,1089.197 ,
1089.585 ,1089.974 ,1090.362 ,1090.750 ,1091.138 ,1091.526 ,1091.914 ,1092.302 ,1092.690 ,1093.078 ,
1093.467 ,1093.855 ,1094.243 ,1094.631 ,1095.019 ,1095.407 ,1095.795 ,1096.183 ,1096.571 ,1096.959 ,
1097.347 ,1097.734 ,1098.122 ,1098.510 ,1098.898 ,1099.286 ,1099.674 ,1100.062 ,1100.450 ,1100.838 ,
1101.225 ,1101.613 ,1102.001 ,1102.389 ,1102.777 ,1103.164 ,1103.552 ,1103.940 ,1104.328 ,1104.715 ,
1105.103 ,1105.491 ,1105.879 ,1106.266 ,1106.654 ,1107.042 ,1107.429 ,1107.817 ,1108.204 ,1108.592 ,
1108.980 ,1109.367 ,1109.755 ,1110.142 ,1110.530 ,1110.917 ,1111.305 ,1111.693 ,1112.080 ,1112.468 ,
1112.855 ,1113.242 ,1113.630 ,1114.017 ,1114.405 ,1114.792 ,1115.180 ,1115.567 ,1115.954 ,1116.342 ,
1116.729 ,1117.117 ,1117.504 ,1117.891 ,1118.279 ,1118.666 ,1119.053 ,1119.441 ,1119.828 ,1120.215 ,
1120.602 ,1120.990 ,1121.377 ,1121.764 ,1122.151 ,1122.538 ,1122.926 ,1123.313 ,1123.700 ,1124.087 ,
1124.474 ,1124.861 ,1125.248 ,1125.636 ,1126.023 ,1126.410 ,1126.797 ,1127.184 ,1127.571 ,1127.958 ,
1128.345 ,1128.732 ,1129.119 ,1130.127 ,1129.893 ,1130.280 ,1130.667 ,1131.054 ,1131.441 ,1131.828 ,
1132.215 ,1132.602 ,1132.988 ,1133.375 ,1133.762 ,1134.149 ,1134.536 ,1134.923 ,1135.309 ,1135.696 ,
1136.083 ,1136.470 ,1136.857 ,1137.243 ,1137.630 ,1138.017 ,1138.404 ,1138.790 ,1139.177 ,1139.564 ,
1139.950 ,1140.337 ,1140.724 ,1141.110 ,1141.497 ,1141.884 ,1142.270 ,1142.657 ,1143.043 ,1143.430 ,
1143.817 ,1144.203 ,1144.590 ,1144.976 ,1145.363 ,1145.749 ,1146.136 ,1146.522 ,1146.909 ,1147.295 ,
1147.681 ,1148.068 ,1148.454 ,1148.841 ,1149.227 ,1149.614 ,1150.000 ,1150.386 ,1150.773 ,1151.159 ,
1151.545 ,1151.932 ,1152.318 ,1152.704 ,1153.091 ,1153.477 ,1153.863 ,1154.249 ,1154.636 ,1155.022 ,
1155.408 ,1155.794 ,1156.180 ,1156.567 ,1156.953 ,1157.339 ,1157.725 ,1158.111 ,1158.497 ,1158.883 ,
1159.270 ,1159.656 ,1160.042 ,1160.428 ,1160.814 ,1161.200 ,1161.586 ,1161.972 ,1162.358 ,1162.744 ,
1163.130 ,1163.516 ,1163.902 ,1164.288 ,1164.674 ,1165.060 ,1165.446 ,1165.831 ,1166.217 ,1166.603 ,
1166.989 ,1167.375 ,1167.761 ,1168.147 ,1168.532 ,1168.918 ,1169.304 ,1169.690 ,1170.076 ,1170.461 ,
1170.847 ,1171.233 ,1171.619 ,1172.004 ,1172.390 ,1172.776 ,1173.161 ,1173.547 ,1173.933 ,1174.318 ,
1174.704 ,1175.090 ,1175.475 ,1175.861 ,1176.247 ,1176.632 ,1177.018 ,1177.403 ,1177.789 ,1178.174 ,
1178.560 ,1178.945 ,1179.331 ,1179.716 ,1180.102 ,1180.487 ,1180.873 ,1181.258 ,1181.644 ,1182.029 ,
1182.414 ,1182.800 ,1183.185 ,1183.571 ,1183.956 ,1184.341 ,1184.727 ,1185.112 ,1185.597 ,1185.883 ,
1186.268 ,1186.653 ,1187.038 ,1187.424 ,1187.809 ,1188.194 ,1188.579 ,1188.965 ,1189.350 ,1189.735 ,
1190.120 ,1190.505 ,1190.890 ,1191.276 ,1191.661 ,1192.046 ,1192.431 ,1192.816 ,1193.201 ,1193.586 ,
1193.971 ,1194.356 ,1194.741 ,1195.126 ,1195.511 ,1195.896 ,1196.281 ,1196.666 ,1197.051 ,1197.436 ,
1197.821 ,1198.206 ,1198.591 ,1198.976 ,1199.361 ,1199.746 ,1200.131 ,1200.516 ,1200.900 ,1201.285 ,
1201.670 ,1202.055 ,1202.440 ,1202.824 ,1203.209 ,1203.594 ,1203.979 ,1204.364 ,1204.748 ,1205.133 ,
1205.518 ,1205.902 ,1206.287 ,1206.672 ,1207.056 ,1207.441 ,1207.826 ,1208.210 ,1208.595 ,1208.980 ,
1209.364 ,1209.749 ,1210.133 ,1210.518 ,1210.902 ,1211.287 ,1211.672 ,1212.056 ,1212.441 ,1212.825 ,
1213.210 ,1213.594 ,1213.978 ,1214.363 ,1214.747 ,1215.120 ,1215.516 ,1215.901 ,1216.285 ,1216.669 ,
1217.054 ,1217.438 ,1217.822 ,1218.207 ,1218.591 ,1218.975 ,1219.360 ,1219.744 ,1220.128 ,1220.513 ,
1220.897 ,1221.281 ,1221.665 ,1222.049 ,1222.434 ,1222.818 ,1223.202 ,1223.586 ,1223.970 ,1224.355 ,
1224.739 ,1225.123 ,1225.507 ,1225.891 ,1226.275 ,1226.659 ,1227.043 ,1227.427 ,1227.811 ,1228.195 ,
1228.579 ,1228.963 ,1229.347 ,1229.731 ,1230.115 ,1230.499 ,1230.883 ,1231.267 ,1231.651 ,1232.035 ,
1232.419 ,1232.803 ,1233.187 ,1233.571 ,1233.955 ,1234.338 ,1234.722 ,1235.106 ,1235.490 ,1235.874 ,
1236.257 ,1236.641 ,1237.025 ,1237.409 ,1237.792 ,1238.176 ,1238.560 ,1238.944 ,1239.327 ,1239.711 ,
1240.095 ,1240.478 ,1240.862 ,1241.246 ,1241.629 ,1242.030 ,1242.396 ,1242.780 ,1243.164 ,1243.547 ,
1243.931 ,1244.314 ,1244.698 ,1245.081 ,1245.465 ,1245.848 ,1246.232 ,1246.615 ,1246.999 ,1247.382 ,
1247.766 ,1248.149 ,1248.533 ,1248.916 ,1249.299 ,1249.683 ,1250.066 ,1250.450 ,1250.833 ,1251.216 ,
1251.600 ,1251.983 ,1252.366 ,1252.749 ,1253.133 ,1253.516 ,1253.899 ,1254.283 ,1254.666 ,1255.049 ,
1255.432 ,1255.815 ,1256.199 ,1256.582 ,1256.965 ,1257.348 ,1257.731 ,1258.114 ,1258.497 ,1258.881 ,
1259.264 ,1259.647 ,1260.030 ,1260.413 ,1260.796 ,1261.179 ,1261.562 ,1261.945 ,1262.328 ,1262.711 ,
1263.094 ,1263.477 ,1263.860 ,1264.243 ,1264.626 ,1265.009 ,1265.392 ,1265.775 ,1266.157 ,1266.540 ,
1266.923 ,1267.306 ,1267.689 ,1268.072 ,1268.455 ,1268.837 ,1269.220 ,1269.603 ,1269.986 ,1270.368 ,
1270.751 ,1271.134 ,1271.517 ,1271.899 ,1272.282 ,1272.665 ,1273.048 ,1273.430 ,1273.813 ,1274.195 ,
1274.578 ,1274.691 ,1274.803 ,1274.916 ,1275.029 ,1275.141 ,1275.254 ,1275.366 ,1275.479 ,1275.591 ,
1278.404 ,1278.786 ,1279.169 ,1279.551 ,1279.934 ,1280.316 ,1280.699 ,1281.081 ,1281.464 ,1281.846 ,
1282.228 ,1282.611 ,1282.993 ,1283.376 ,1283.758 ,1284.140 ,1284.523 ,1284.905 ,1285.287 ,1285.670 ,
1286.052 ,1286.434 ,1286.816 ,1287.199 ,1287.581 ,1287.963 ,1288.345 ,1288.728 ,1289.110 ,1289.492 ,
1289.874 ,1290.256 ,1290.638 ,1291.021 ,1291.403 ,1291.785 ,1292.167 ,1292.549 ,1292.931 ,1293.313 ,
1293.695 ,1294.077 ,1294.459 ,1294.841 ,1295.223 ,1295.605 ,1295.987 ,1296.369 ,1296.751 ,1297.133 ,
1297.515 ,1297.897 ,1298.279 ,1298.661 ,1299.043 ,1299.425 ,1299.807 ,1300.188 ,1300.570 ,1300.952 ,
1301.334 ,1301.716 ,1302.098 ,1302.479 ,1302.861 ,1303.243 ,1303.625 ,1304.006 ,1304.388 ,1304.770 ,
1305.152 ,1305.533 ,1305.915 ,1306.297 ,1306.678 ,1307.060 ,1307.442 ,1307.823 ,1308.205 ,1308.586 ,
1308.968 ,1309.350 ,1309.731 ,1310.113 ,1310.494 ,1310.876 ,1311.270 ,1311.639 ,1312.020 ,1312.402 ,
1312.783 ,1313.165 ,1313.546 ,1313.928 ,1314.309 ,1314.691 ,1315.072 ,1315.453 ,1315.835 ,1316.216 ,
1316.597 ,1316.979 ,1317.360 ,1317.742 ,1318.123 ,1318.504 ,1318.885 ,1319.267 ,1319.648 ,1320.029 ,
1320.411 ,1320.792 ,1321.173 ,1321.554 ,1321.935 ,1322.316 ,1322.697 ,1323.079 ,1323.460 ,1323.841 ,
1324.222 ,1324.603 ,1324.985 ,1325.366 ,1325.747 ,1326.128 ,1326.509 ,1326.890 ,1327.271 ,1327.652 ,
1328.033 ,1328.414 ,1328.795 ,1329.176 ,1329.557 ,1329.938 ,1330.319 ,1330.700 ,1331.081 ,1331.462 ,
1331.843 ,1332.224 ,1332.604 ,1332.985 ,1333.366 ,1333.747 ,1334.128 ,1334.509 ,1334.889 ,1335.270 ,
1335.651 ,1336.032 ,1336.413 ,1336.793 ,1337.174 ,1337.555 ,1337.935 ,1338.316 ,1338.697 ,1339.078 ,
1339.458 ,1335.839 ,1332.220 ,1328.600 ,1324.981 ,1321.361 ,1317.742 ,1314.123 ,1310.503 ,1306.884 ,
1343.264 ,1343.645 ,1344.025 ,1344.406 ,1344.786 ,1345.167 ,1345.570 ,1345.928 ,1346.308 ,1346.689 ,
1347.069 ,1347.450 ,1347.830 ,1348.211 ,1348.591 ,1348.971 ,1349.352 ,1349.732 ,1350.112 ,1350.493 ,
1350.873 ,1351.253 ,1351.634 ,1352.014 ,1352.394 ,1352.774 ,1353.155 ,1353.535 ,1353.915 ,1354.295 ,
1354.676 ,1355.056 ,1355.436 ,1355.816 ,1356.196 ,1356.577 ,1356.957 ,1357.337 ,1357.717 ,1358.097 ,
1358.477 ,1358.857 ,1359.237 ,1359.617 ,1359.997 ,1360.377 ,1360.757 ,1361.137 ,1361.517 ,1361.897 ,
1362.277 ,1362.657 ,1363.037 ,1363.417 ,1363.797 ,1364.177 ,1364.557 ,1364.937 ,1365.317 ,1365.697 ,
1366.077 ,1366.456 ,1366.836 ,1367.216 ,1367.596 ,1367.976 ,1368.355 ,1368.735 ,1369.115 ,1369.495 ,
1369.875 ,1370.254 ,1370.634 ,1371.014 ,1371.393 ,1371.773 ,1372.153 ,1372.532 ,1372.912 ,1373.292 ,
1373.671 ,1374.051 ,1374.431 ,1374.810 ,1375.190 ,1375.569 ,1375.949 ,1376.329 ,1376.708 ,1377.088 ,
1377.467 ,1377.847 ,1378.226 ,1378.606 ,1378.985 ,1379.365 ,1379.744 ,1380.123 ,1380.503 ,1380.882 ,
1381.262 ,1381.641 ,1382.020 ,1382.400 ,1382.779 ,1383.158 ,1383.538 ,1383.917 ,1384.296 ,1384.676 ,
1385.055
};

float pt100_res_to_temp(float resistance) {
    uint16_t low = 0;
    uint16_t mid = sizeof(pt100_table) / sizeof(pt100_table[0]) / 2;
    uint16_t high = sizeof(pt100_table) / sizeof(pt100_table[0]) - 1;

    if((resistance < pt100_table[0]) || (resistance > pt100_table[high])) {
        return -100; 
    }
    while(high >= low) {
        mid = (high + low) / 2;
        if(resistance >= pt100_table[mid]) {
            if(resistance < pt100_table[mid + 1]) {
                float temp = (0.1 * low + (resistance - pt100_table[mid]) * 0.1 / ((pt100_table[mid + 1]) - pt100_table[mid]));
                if(resistance >= 100) {
                    return temp-50;
                } else {
                    return 0 - ( 49.9 - temp );
                }
                //break;
            } else {
                low = mid + 1;
            }
        } else if(resistance < pt100_table[mid]) {
            high = mid - 1;
        }
    }
    return 0;
}

float pt1000_res_to_temp(float resistance) {
    uint16_t low = 0;
    uint16_t mid = sizeof(pt1000_table) / sizeof(pt1000_table[0]) / 2;
    uint16_t high = sizeof(pt1000_table) / sizeof(pt1000_table[0]) - 1;

    if((resistance < pt1000_table[0]) || (resistance > pt1000_table[high])) {
        return -100; 
    }
    while(high >= low) {
        mid = (high + low) / 2;
        if(resistance >= pt1000_table[mid]) {
            if(resistance < pt1000_table[mid + 1]) {
                float temp = (0.1 * low + (resistance - pt1000_table[mid]) * 0.1 / ((pt1000_table[mid + 1]) - pt1000_table[mid]));
                if(resistance >= 100) {
                    return temp-50;
                } else {
                    return 0 - ( 49.9 - temp );
                }
                //break;
            } else {
                low = mid + 1;
            }
        } else if(resistance < pt1000_table[mid]) {
            high = mid - 1;
        }
    }
    return 0;
}

/*!
    \brief      configure the DMA peripheral
    \param[in]  none
    \param[out] none
    \retval     none
*/
/*!
    \brief      configure the different system clocks
    \param[in]  none
    \param[out] none
    \retval     none
*/
static void rcu_config(void) {
    rcu_periph_clock_enable(RCU_ADC0); 			 /* enable ADC clock */
    rcu_periph_clock_enable(RCU_DMA0);  		 /* enable DMA0 clock */
    rcu_adc_clock_config(RCU_CKADC_CKAPB2_DIV8); /* config ADC clock */
    rcu_periph_clock_enable(RCU_DAC);
    
    rcu_periph_clock_enable(RCU_GPIOC);
    rcu_periph_clock_enable(RCU_GPIOB);
    rcu_periph_clock_enable(RCU_GPIOA);
}

/*!
    \brief      configure the GPIO peripheral
    \param[in]  none
    \param[out] none
    \retval     none
*/
static void gpio_config(void) {
    gpio_init(GPIOC, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_1); //11
    gpio_init(GPIOA, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_0); //0
    gpio_init(GPIOA, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_3); //3
    gpio_init(GPIOA, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_5); //12-5

    gpio_init(GPIOC, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_4); //12-14
    gpio_init(GPIOC, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_5); //12-15

    gpio_init(GPIOB, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_0); //12-8
    gpio_init(GPIOB, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_1); //12-9
    
    gpio_init(GPIOC, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_0); //10
    
    gpio_init(GPIOA, GPIO_MODE_AIN, GPIO_OSPEED_50MHZ, GPIO_PIN_4);//AD
}

/*!
    \brief      configure the DAC
    \param[in]  none
    \param[out] none
    \retval     none
*/
void dac_config(void) {
    dac_deinit();
    /* configure the DAC1 */
    dac_wave_mode_config(DAC0, DAC_WAVE_DISABLE);
    dac_triangle_noise_config(DAC0, DAC_TRIANGLE_AMPLITUDE_2047);
    dac_output_buffer_enable(DAC0);
    dac_software_trigger_disable(DAC0);
    
    /* enable DAC1 and set data */
    dac_enable(DAC0);//
    float cur = ( 10 * 3 );
    dac_data_set(DAC0, DAC_ALIGN_12B_R, ( ( ( 0xfff * ( cur ) ) / 3.3 ) / 10 ) - 10 );
}

/*!
    \brief      configure the DMA peripheral
    \param[in]  none
    \param[out] none
    \retval     none
*/
static void dma_config(void) {
    /* ADC_DMA_channel configuration */
    dma_parameter_struct dma_data_parameter;
    
    /* ADC DMA_channel configuration */
    dma_deinit(DMA0, DMA_CH0);
    
    /* initialize DMA single data mode */
    dma_data_parameter.periph_addr  = (uint32_t)(&ADC_RDATA(ADC0));
    dma_data_parameter.periph_inc   = DMA_PERIPH_INCREASE_DISABLE;
    dma_data_parameter.memory_addr  = (uint32_t)(&adc_value);
    dma_data_parameter.memory_inc   = DMA_MEMORY_INCREASE_ENABLE;
    dma_data_parameter.periph_width = DMA_PERIPHERAL_WIDTH_16BIT;
    dma_data_parameter.memory_width = DMA_MEMORY_WIDTH_16BIT;  
    dma_data_parameter.direction    = DMA_PERIPHERAL_TO_MEMORY;
    dma_data_parameter.number       = 9;
    dma_data_parameter.priority     = DMA_PRIORITY_HIGH;
    dma_init(DMA0, DMA_CH0, dma_data_parameter);
    dma_circulation_enable(DMA0, DMA_CH0);
  
    /* enable DMA channel */
    dma_channel_enable(DMA0, DMA_CH0);
}

/*!
    \brief      configure the ADC peripheral
    \param[in]  none
    \param[out] none
    \retval     none
*/
static void adc_config(void) {
    adc_external_trigger_source_config(ADC0, ADC_REGULAR_CHANNEL, ADC0_1_2_EXTTRIG_REGULAR_NONE);  /* ADC trigger config */
    adc_external_trigger_config(ADC0, ADC_REGULAR_CHANNEL, ENABLE);
    
    adc_data_alignment_config(ADC0, ADC_DATAALIGN_RIGHT);                         /* ADC data alignment config */
    adc_mode_config(ADC_MODE_FREE);                                               /* ADC mode config */
    adc_channel_length_config(ADC0, ADC_REGULAR_CHANNEL, 9);                      /* ADC channel length config */
    adc_regular_channel_config(ADC0, 0, ADC_CHANNEL_11, ADC_SAMPLETIME_71POINT5); /* ADC regular channel config */
    adc_regular_channel_config(ADC0, 1, ADC_CHANNEL_0, ADC_SAMPLETIME_71POINT5); /* ADC regular channel config */
    adc_regular_channel_config(ADC0, 2, ADC_CHANNEL_3, ADC_SAMPLETIME_71POINT5); /* ADC regular channel config */
    adc_regular_channel_config(ADC0, 3, ADC_CHANNEL_5, ADC_SAMPLETIME_71POINT5); /* ADC regular channel config */
    adc_regular_channel_config(ADC0, 4, ADC_CHANNEL_14, ADC_SAMPLETIME_71POINT5); /* ADC regular channel config */
    adc_regular_channel_config(ADC0, 5, ADC_CHANNEL_15, ADC_SAMPLETIME_71POINT5); /* ADC regular channel config */
    adc_regular_channel_config(ADC0, 6, ADC_CHANNEL_8, ADC_SAMPLETIME_71POINT5); /* ADC regular channel config */
    adc_regular_channel_config(ADC0, 7, ADC_CHANNEL_9, ADC_SAMPLETIME_71POINT5); /* ADC regular channel config */
    adc_regular_channel_config(ADC0, 8, ADC_CHANNEL_10, ADC_SAMPLETIME_71POINT5); /* ADC regular channel config */
    adc_discontinuous_mode_config(ADC0, ADC_REGULAR_CHANNEL, 3);/* ADC discontinuous mode */
    adc_enable(ADC0);/* enable ADC interface */
    delay_ms(1);/* wait adc enable must*/
    adc_calibration_enable(ADC0);/* ADC calibration and reset calibration */
    adc_dma_mode_enable(ADC0);
     /* ADC software trigger enable */
    adc_software_trigger_enable(ADC0, ADC_REGULAR_CHANNEL);
}

/* 标定补偿值 */
static int v1ma_bc = 0;
static int v10ma_bc = 0;
static int vval_bc[16];
static int vcur_bc[16];
static int vpt100_bc = 0;
static int vpt1000_bc = 0;

void analog_quantity_init(void) {
    rcu_config();
    gpio_config();
    dma_config();
    adc_config();
    dac_config();
    uint32_t dat;
    flash_read(C_FLAG,&dat);
    if(dat != 0x55) {
        dat = 0x55;
        flash_write(C_FLAG,dat);
        flash_write(C_1MA_BZ,0x00);
        flash_write(C_10MA_BZ,0x00);
        for(uint8_t i = 0;i < 16;i++) {
            flash_write(C_VAL_BZ+i,0x00);
            vval_bc[i] = 0;
        }
        for(uint8_t i = 0;i < 16;i++) {
            flash_write(C_CUR_BZ+i,0x00);
            vcur_bc[i] = 0;
        }
        flash_write(C_PT100_BZ,0);
        flash_write(C_PT1000_BZ,0);
    } else {
        flash_read(C_1MA_BZ,(uint32_t *)&v1ma_bc);
        flash_read(C_10MA_BZ,(uint32_t *)&v10ma_bc);
        for(uint8_t i = 0;i < 16;i++) {
            flash_read(C_VAL_BZ+i,(uint32_t *)&vval_bc[i]);
        }
        for(uint8_t i = 0;i < 16;i++) {
            flash_read(C_CUR_BZ+i,(uint32_t *)&vcur_bc[i]);
        }
        flash_read(C_PT100_BZ,(uint32_t *)&vpt100_bc);
        flash_read(C_PT1000_BZ,(uint32_t *)&vpt1000_bc);
    }
    
    for(int i = 0;i < 8;i++) {
        k_val[i].AdjustVar = 0;
        k_val[i].PreOptimalVar = 1;
        k_val[i].CurMeasVar = 0;
        k_val[i].CurEstimateVar = 0;
        k_val[i].CurOptimalVar = 0;
        k_val[i].CurSysCoVar = 0;
        k_val[i].PreSysCoVar = 30;
        k_val[i].KalmanGain = 0;
    }
    
}

/* 设置通道模式 */
void analog_quantity_set_ch_mode(ads_read_mode mode,check_channel passageway) {
    if(passageway < 8) {
        read_config_mode(mode,passageway);
        al_am[passageway] = mode;
    }
}

float analog_quantity_get(check_channel ch) {
    if(ch < 8) {
        switch(al_am[ch]) {
            case PT100: {
                return pt100_res_to_temp( (float)( ( (average_value[ch] + vpt100_bc) * 3300 / 0xfff) * 0.1 ) ); //0.1
            }
            case PT1000: {
                return pt1000_res_to_temp( (float)( ( (average_value[ch] + vpt1000_bc) * 3300 / 0xfff) * 1 ) ); //0.1
            }
            case VOLTAGE: {
                if(average_value[ch] + vval_bc[ch*2] >= 0) {
                    return (average_value[ch] + vval_bc[ch*2]) * (10.0 / vval_bc[ch*2+1]);
                } else {
                    return 0;
                }
            }
            case ELE_CURRENT: {
                if(average_value[ch] + vcur_bc[ch*2] >= 0) {
                    return (average_value[ch] + vcur_bc[ch*2]) * (20.0 / vcur_bc[ch*2+1]);
                } else {
                    return 0;
                }
            }
            case AM_NULL: {
                return -1000.0;
            }
        }
    }
    return -1000.0;
}

static uint16_t analog_quantity_get_hex(check_channel ch) {
    if(ch < 8) {
        switch(al_am[ch]) {
            case PT100: {
                read_config_pass_set(ch);
                delay_ms(1);
                dac_data_set(DAC0, DAC_ALIGN_12B_R, 3723 + v10ma_bc );
                delay_ms(10);
                for(uint8_t i = 0; i < 9;i++) {
                    adc_software_trigger_enable(ADC0, ADC_REGULAR_CHANNEL); /* ADC software trigger enable */
                    delay_ms(1);
                }
                return adc_value[8];
            }
            case PT1000: {
                read_config_pass_set(ch);
                delay_ms(1);
                dac_data_set(DAC0, DAC_ALIGN_12B_R, 372 + v1ma_bc );
                delay_ms(10);
                for(uint8_t i = 0; i < 9;i++) {
                    adc_software_trigger_enable(ADC0, ADC_REGULAR_CHANNEL); /* ADC software trigger enable */
                    delay_ms(1);
                }
                return adc_value[8];
            }
            case VOLTAGE: {
                for(uint8_t i = 0; i < 9;i++) {
                    adc_software_trigger_enable(ADC0, ADC_REGULAR_CHANNEL); /* ADC software trigger enable */
                    delay_ms(2);
                }
                return adc_value[ch];
            }
            case ELE_CURRENT: {
                for(uint8_t i = 0; i < 9;i++) {
                    adc_software_trigger_enable(ADC0, ADC_REGULAR_CHANNEL); /* ADC software trigger enable */
                    delay_ms(2);
                }
                return adc_value[ch];
            }
            case AM_NULL: {
                return 0xffff;
            }
        }
    }
    return 0xffff;
}



#define SysNoiseCoVar         (0.08)
#define MeasNoiseCoVar        (30.7415926) //系统噪声协方差，测量噪声协方差

/*卡尔曼滤波需要设置4个值，其余均可自动调整*/
uint16_t KalmanFitterAD1(uint16_t MeasVar, struct kanlman_val * val) {
    
    val->CurMeasVar=MeasVar;                         //当前系统测量值
    //先前系统最优值和先前系统协方差需要设置非零初始值；；；；
    /*当前估计值=先前最优值+调整值*/
    val->CurEstimateVar=val->PreOptimalVar+val->AdjustVar;
    val->AdjustVar=0;                                //设定调整值的原因是加快调整速度
    /*当前系统协方差=先前系统协方差+系统噪声协方差*/
    val->CurSysCoVar=val->PreSysCoVar+SysNoiseCoVar;
    /*卡尔曼增益=当前系统协方差/(当前系统协方差+测量噪声协方差)*/
    val->KalmanGain=val->CurSysCoVar/(val->CurSysCoVar+MeasNoiseCoVar);
    /*当前系统最优值=当前系统估计值+卡尔曼增益*（测量值-当前系统估计值）*/
    val->CurOptimalVar=val->CurEstimateVar+val->KalmanGain*(val->CurMeasVar-val->CurEstimateVar);
    /*先前系统噪声协方差=（1-卡尔曼增益）x当前系统协方差*/
    val->PreSysCoVar =(1-val->KalmanGain)*val->CurSysCoVar;
    val->PreOptimalVar=val->CurOptimalVar;		//递归处理当前系统最优值
    /*返回数据*/
    return (uint16_t)val->CurOptimalVar;
}

void analog_quantity_tic_100ms( void ) {
    static uint8_t count_tic = 0;
    static float val_hex[8];
    if(count_tic < 20) {
        count_tic++;
        for(int i = 0;i < 8;i++) {
            if( (al_am[i] == PT100) || (al_am[i] == PT1000) ) {
                average_value[i] = KalmanFitterAD1(analog_quantity_get_hex((check_channel)i), &k_val[i]);
            } else {
                uint16_t val_y = analog_quantity_get_hex((check_channel)i);
                if(count_tic == 1) {
                    val_hex[i] = val_y;
                } else {
                    val_hex[i] += val_y;
                    val_hex[i] *= 0.5;
                }
            }
        }
    } else {
        count_tic = 0;
        for(int i = 0;i < 8;i++) {
            if( (al_am[i] != PT100) && (al_am[i] != PT1000) ) {
                average_value[i] = val_hex[i];
            }
        }
    }
}

static uint8_t calibration_flag = 0;

uint8_t analog_quantity_calibration_flag_get( void ) {
    return calibration_flag;
}

void analog_quantity_calibration(uint8_t * cmd) {
    calibration_flag = 1;
    switch(cmd[0]) {
        case 0x00: { /* 设置通道模式 */
            if( cmd[1] < 8 ) { /* 通道 */
                analog_quantity_set_ch_mode( (ads_read_mode)cmd[2],(check_channel)cmd[1] );
            } else {
                analog_quantity_set_ch_mode( (ads_read_mode)cmd[2],CC_1 );
                analog_quantity_set_ch_mode( (ads_read_mode)cmd[2],CC_2 );
                analog_quantity_set_ch_mode( (ads_read_mode)cmd[2],CC_3 );
                analog_quantity_set_ch_mode( (ads_read_mode)cmd[2],CC_4 );
                analog_quantity_set_ch_mode( (ads_read_mode)cmd[2],CC_5 );
                analog_quantity_set_ch_mode( (ads_read_mode)cmd[2],CC_6 );
                analog_quantity_set_ch_mode( (ads_read_mode)cmd[2],CC_7 );
                analog_quantity_set_ch_mode( (ads_read_mode)cmd[2],CC_8 );
            }
        } break;
        case 0x01: { /* 设置电流通道 */
            read_config_pass_set((check_channel)cmd[2]);
            delay_ms(5);
            if(cmd[1] == 0) { /* 10ma */
                dac_data_set(DAC0, DAC_ALIGN_12B_R, 3723 + v10ma_bc );
            } else {  /* 1ma */
                dac_data_set(DAC0, DAC_ALIGN_12B_R, 372 + v1ma_bc );
            }
        } break;
        case 0x02: { /* 获取值*/
            switch(cmd[1]) {
                case 0: { //1ma
                    
                } break;
                case 1: { // 10ma
                    
                } break;
                case 2: { // 电压
                    uint16_t xval = 0;
                    
                    for(uint8_t j = 0; j < 20;j++) {
                        for(uint8_t i = 0; i < 9;i++) {
                            adc_software_trigger_enable(ADC0, ADC_REGULAR_CHANNEL); /* ADC software trigger enable */
                            delay_ms(1);
                        }
                        if(j == 1) {
                            xval = adc_value[cmd[2]];
                        } else {
                            xval += adc_value[cmd[2]];
                            xval *= 0.5;
                        }
                        delay_ms(5);
                    }
                    
                    can_trasnmit_message_struct send_msg;
                    send_msg.tx_sfid = 0x0154;
                    send_msg.tx_dlen = 4;
                    send_msg.tx_data[0] = 2; /* 设备类型 */
                    send_msg.tx_data[1] = 2; /* 命令 */
                    send_msg.tx_data[2] = (xval & 0x00ff);
                    send_msg.tx_data[3] = (xval >> 8);
                    bxcan_send(send_msg);
                } break;
                case 3: { // 电流
                    uint16_t xval = 0;
                    
                    for(uint8_t j = 0; j < 20;j++) {
                        for(uint8_t i = 0; i < 9;i++) {
                            adc_software_trigger_enable(ADC0, ADC_REGULAR_CHANNEL); /* ADC software trigger enable */
                            delay_ms(1);
                        }
                        if(j == 1) {
                            xval = adc_value[cmd[2]];
                        } else {
                            xval += adc_value[cmd[2]];
                            xval *= 0.5;
                        }
                        delay_ms(5);
                    }
                    
                    can_trasnmit_message_struct send_msg;
                    send_msg.tx_sfid = 0x0154;
                    send_msg.tx_dlen = 4;
                    send_msg.tx_data[0] = 2; /* 设备类型 */
                    send_msg.tx_data[1] = 3; /* 命令 */
                    send_msg.tx_data[2] = (xval & 0x00ff);
                    send_msg.tx_data[3] = (xval >> 8);
                    bxcan_send(send_msg);
                } break;
                case 4: { //pt100 
                    read_config_pass_set(CC_5);
                    delay_ms(1);
                    dac_data_set(DAC0, DAC_ALIGN_12B_R, 3723 + v10ma_bc );
                    delay_ms(10);
                    
                    uint16_t xval = 0;
                    
                    for(uint8_t j = 0; j < 20;j++) {
                        for(uint8_t i = 0; i < 9;i++) {
                            adc_software_trigger_enable(ADC0, ADC_REGULAR_CHANNEL); /* ADC software trigger enable */
                            delay_ms(1);
                        }
                        if(j == 1) {
                            xval = adc_value[8];
                        } else {
                            xval += adc_value[8];
                            xval *= 0.5;
                        }
                        delay_ms(5);
                    }
                    
                    can_trasnmit_message_struct send_msg;
                    send_msg.tx_sfid = 0x0154;
                    send_msg.tx_dlen = 4;
                    send_msg.tx_data[0] = 2; /* 设备类型 */
                    send_msg.tx_data[1] = 4; /* 命令 */
                    send_msg.tx_data[2] = (xval & 0x00ff);
                    send_msg.tx_data[3] = (xval >> 8);
                    bxcan_send(send_msg);
                } break;
                case 5: { //pt1000 
                    
                    read_config_pass_set(CC_5);
                    delay_ms(1);
                    dac_data_set(DAC0, DAC_ALIGN_12B_R, 372 + v1ma_bc );
                    delay_ms(10);
                    
                    uint16_t xval = 0;
                    
                    for(uint8_t j = 0; j < 20;j++) {
                        for(uint8_t i = 0; i < 9;i++) {
                            adc_software_trigger_enable(ADC0, ADC_REGULAR_CHANNEL); /* ADC software trigger enable */
                            delay_ms(1);
                        }
                        if(j == 1) {
                            xval = adc_value[8];
                        } else {
                            xval += adc_value[8];
                            xval *= 0.5;
                        }
                        delay_ms(5);
                    }
                    
                    can_trasnmit_message_struct send_msg;
                    send_msg.tx_sfid = 0x0154;
                    send_msg.tx_dlen = 4;
                    send_msg.tx_data[0] = 2; /* 设备类型 */
                    send_msg.tx_data[1] = 5; /* 命令 */
                    send_msg.tx_data[2] = (xval & 0x00ff);
                    send_msg.tx_data[3] = (xval >> 8);
                    bxcan_send(send_msg);
                } break;
            }
        } break;
        case 0x03: { /* 修改配置值 */
            switch(cmd[1]) {
                case 0: { //1ma
                    v1ma_bc = cmd[2];
                    v1ma_bc |= (cmd[3] << 8);
                    v1ma_bc |= (cmd[4] << 16);
                    v1ma_bc |= (cmd[5] << 24);
                } break;
                case 1: { // 10ma
                    v10ma_bc = cmd[2];
                    v10ma_bc |= (cmd[3] << 8);
                    v10ma_bc |= (cmd[4] << 16);
                    v10ma_bc |= (cmd[5] << 24);
                } break;
                case 2: { // 电压
                    vval_bc[cmd[2]] = cmd[3];
                    vval_bc[cmd[2]] |= (cmd[4] << 8);
                    vval_bc[cmd[2]] |= (cmd[5] << 16);
                    vval_bc[cmd[2]] |= (cmd[6] << 24);
                } break;
                case 3: { // 电流
                    vcur_bc[cmd[2]] = cmd[3];
                    vcur_bc[cmd[2]] |= (cmd[4] << 8);
                    vcur_bc[cmd[2]] |= (cmd[5] << 16);
                    vcur_bc[cmd[2]] |= (cmd[6] << 24);
                } break;
                case 4: { //pt100
                    vpt100_bc = cmd[2];
                    vpt100_bc |= (cmd[3] << 8);
                    vpt100_bc |= (cmd[4] << 16);
                    vpt100_bc |= (cmd[5] << 24);
                    
                    vpt100_bc = (1241 + vpt100_bc);
                    
                } break;
                case 5: { //pt1000
                    vpt1000_bc = cmd[2];
                    vpt1000_bc |= (cmd[3] << 8);
                    vpt1000_bc |= (cmd[4] << 16);
                    vpt1000_bc |= (cmd[5] << 24);
                    
                    vpt1000_bc = (1241 + vpt1000_bc);
                } break;
            }
        } break;
        case 0x04: { /* 保存配置值 */
            flash_write(C_FLAG,0x55);
            
            flash_write(C_1MA_BZ,v1ma_bc);
            flash_write(C_10MA_BZ,v10ma_bc);
            for(uint8_t i = 0;i < 16;i++) {
                flash_write(C_VAL_BZ+i,vval_bc[i]);
            }
            for(uint8_t i = 0;i < 16;i++) {
                flash_write(C_CUR_BZ+i,vcur_bc[i]);
            }
            flash_write(C_PT100_BZ,vpt100_bc);
            flash_write(C_PT1000_BZ,vpt1000_bc);
            
            calibration_flag = 0;
        } break;
    }
}


